<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Speech Rate Limiter v1.7</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    button { margin-right: 10px; }
    .chunking { color: orange; font-style: italic; }
  </style>
</head>
<body>
  <h1>Speech Rate Limiter</h1>
  <p><strong>Version:</strong> <span id="version">v1.7</span></p>

  <button id="startBtn">Start Listening</button>
  <button id="stopBtn" disabled>Stop Listening</button>
  <br /><br />

  <label for="wpmThreshold">Set WPM Threshold:</label>
  <input type="number" id="wpmThreshold" value="120" min="1" />
  
  <p>Total Words: <span id="totalWords">0</span></p>
  <p>Current Avg WPM: <span id="currentWPM">0</span></p>
  <p>Status: <span id="status">Idle</span> <span id="chunking" class="chunking"></span></p>

  <!-- Beep sound alert -->
  <audio id="alertSound" preload="auto">
    <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=" type="audio/wav" />
  </audio>

  <script>
    let recognition;
    let totalWords = 0;
    let wordBuffer = [];
    let startTime;
    let alertCooldown = 5000;
    let lastAlertTime = 0;
    let isListening = false;
    let chunkTimer;

    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const statusEl = document.getElementById("status");
    const chunkingEl = document.getElementById("chunking");
    const alertSound = document.getElementById("alertSound");

    function setupRecognition() {
      const recog = new webkitSpeechRecognition();
      recog.lang = "en-US";
      recog.continuous = false;
      recog.interimResults = false;

      recog.onresult = (event) => {
        const now = Date.now();
        for (let i = event.resultIndex; i < event.results.length; i++) {
          if (event.results[i].isFinal) {
            const transcript = event.results[i][0].transcript.trim();
            const words = transcript.split(/\s+/).filter(Boolean);
            const count = words.length;
            totalWords += count;
            wordBuffer.push({ time: now, count });

            document.getElementById("totalWords").textContent = totalWords;

            // Clean buffer older than 60 seconds
            wordBuffer = wordBuffer.filter((entry) => now - entry.time <= 60000);

            // Calculate average WPM
            const elapsedMin = (now - startTime) / 60000;
            const avgWPM = Math.round(totalWords / elapsedMin);
            document.getElementById("currentWPM").textContent = avgWPM;

            // Check for WPM burst
            const recent5s = wordBuffer.filter((e) => now - e.time <= 5000);
            const recentCount = recent5s.reduce((sum, e) => sum + e.count, 0);
            const threshold = parseInt(document.getElementById("wpmThreshold").value);
            const maxWordsPer5s = threshold / 12;

            if (recentCount > maxWordsPer5s && now - lastAlertTime > alertCooldown) {
              lastAlertTime = now;
              alertSound.play().catch(() => {});
              alert(`🚨 Speech rate exceeded!\nSpoke ${recentCount} words in 5 seconds\nLimit: ${maxWordsPer5s.toFixed(1)} words`);
            }
          }
        }
      };

      recog.onerror = (event) => {
        console.error("Recognition error:", event.error);
        if (isListening && event.error !== "not-allowed") {
          restartRecognition();
        }
      };

      recog.onend = () => {
        if (isListening) {
          // If recognition ends unexpectedly, restart it
          startRecognition();
        } else {
          statusEl.textContent = "Stopped";
          chunkingEl.textContent = "";
        }
      };

      return recog;
    }

    function startRecognition() {
      if (recognition) {
        recognition.onresult = null;
        recognition.onend = null;
        recognition.onerror = null;
        try { recognition.stop(); } catch (e) {}
      }
      recognition = setupRecognition();
      recognition.start();
      statusEl.textContent = "Listening...";
    }

    function startChunkingTimer() {
      chunkingEl.textContent = "Listening…";

      chunkTimer = setInterval(() => {
        chunkingEl.textContent = "⏳ Chunking...";
        setTimeout(() => {
          chunkingEl.textContent = "Listening…";
        }, 1000);

        if (recognition) {
          try {
            recognition.onend = null; // prevent double restart
            recognition.stop();
          } catch (e) {}
        }

        // Force restart recognition directly
        setTimeout(() => {
          if (isListening) {
            startRecognition();
          }
        }, 300); // short pause between stop/start
      }, 5000);
    }

    function stopChunkingTimer() {
      clearInterval(chunkTimer);
      chunkingEl.textContent = "";
    }

    function startListening() {
      if (!("webkitSpeechRecognition" in window)) {
        alert("Speech recognition not supported in this browser.");
        return;
      }

      totalWords = 0;
      wordBuffer = [];
      startTime = Date.now();
      lastAlertTime = 0;
      isListening = true;

      startBtn.disabled = true;
      stopBtn.disabled = false;

      startRecognition();
      startChunkingTimer();
    }

    function stopListening() {
      isListening = false;
      stopChunkingTimer();

      if (recognition) {
        try { recognition.stop(); } catch (e) {}
        recognition = null;
      }

      startBtn.disabled = false;
      stopBtn.disabled = true;
      statusEl.textContent = "Stopped";
      chunkingEl.textContent = "";
    }

    startBtn.onclick = startListening;
    stopBtn.onclick = stopListening;
  </script>
</body>
</html>
